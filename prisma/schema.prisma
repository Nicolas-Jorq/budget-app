generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  name                  String
  password              String
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  // Finance module relations
  budgets               Budget[]
  transactions          Transaction[]
  savingsGoals          SavingsGoal[]
  bankAccounts          BankAccount[]
  bankDocuments         BankDocument[]
  recurringTransactions RecurringTransaction[]
  categories            Category[]
  // Module system relations
  modules               UserModule[]
  obsidianSync          ObsidianSync?
  // Health module relations
  workouts              Workout[]
  weightLogs            WeightLog[]
  meals                 Meal[]
  sleepLogs             SleepLog[]
  waterLogs             WaterLog[]
  healthGoals           HealthGoal[]

  @@map("users")
}

// ==========================================
// Module System - Enables multi-domain architecture
// ==========================================

enum ModuleType {
  FINANCE      // Budgets, transactions, savings goals
  HEALTH       // Meals, exercise, health metrics
  TASKS        // Todos, projects, deadlines
  LIFE_GOALS   // Non-financial life objectives
}

/// Tracks which modules are enabled for each user
model UserModule {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  module    ModuleType
  enabledAt DateTime   @default(now())
  settings  Json?      // Module-specific user preferences

  @@unique([userId, module])
  @@map("user_modules")
}

/// Obsidian vault integration configuration
model ObsidianSync {
  id           String    @id @default(cuid())
  userId       String    @unique
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  vaultPath    String?   // Local path to Obsidian vault
  lastExport   DateTime?
  lastImport   DateTime?
  syncSettings Json?     // What to sync, frequency, folder structure
  isEnabled    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("obsidian_syncs")
}

// ==========================================
// User-Configurable Categories
// ==========================================

enum CategoryType {
  EXPENSE
  INCOME
  BOTH    // Can be used for both income and expense
}

model Category {
  id        String       @id @default(cuid())
  name      String
  type      CategoryType
  color     String?      // Hex color for charts/display
  icon      String?      // Icon identifier
  isDefault Boolean      @default(false) // System default vs user-created
  sortOrder Int          @default(0)
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([userId, name])
  @@map("categories")
}

model Budget {
  id                    String                 @id @default(cuid())
  name                  String
  amount                Decimal                @db.Decimal(10, 2)
  spent                 Decimal                @default(0) @db.Decimal(10, 2)
  category              String
  userId                String
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions          Transaction[]
  recurringTransactions RecurringTransaction[]
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  @@map("budgets")
}

model Transaction {
  id                     String               @id @default(cuid())
  description            String
  amount                 Decimal              @db.Decimal(10, 2)
  type                   String               // 'income' or 'expense'
  category               String
  date                   DateTime
  budgetId               String?
  budget                 Budget?              @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  userId                 String
  user                   User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions          Contribution[]
  recurringTransactionId String?              // If generated from recurring
  recurringTransaction   RecurringTransaction? @relation(fields: [recurringTransactionId], references: [id], onDelete: SetNull)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@map("transactions")
}

// ==========================================
// Recurring Transactions System
// ==========================================

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model RecurringTransaction {
  id                String              @id @default(cuid())
  name              String              // User-friendly name (e.g., "Netflix Subscription")
  description       String              // Description for generated transactions
  amount            Decimal             @db.Decimal(10, 2)
  type              String              // 'income' or 'expense'
  category          String
  frequency         RecurrenceFrequency
  startDate         DateTime            // When the recurrence starts
  endDate           DateTime?           // Optional end date
  dayOfMonth        Int?                // For MONTHLY: 1-31 (null = same as start date)
  dayOfWeek         Int?                // For WEEKLY: 0-6 (Sunday-Saturday)
  budgetId          String?
  budget            Budget?             @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  isActive          Boolean             @default(true)
  lastGeneratedDate DateTime?           // Last time a transaction was generated
  nextDueDate       DateTime            // Next scheduled transaction date
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedTransactions Transaction[]   // Transactions created from this recurring
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("recurring_transactions")
}

// Savings Goals System
enum GoalType {
  EMERGENCY_FUND
  BABY
  HOUSE
  VEHICLE
  VACATION
  EDUCATION
  RETIREMENT
  CUSTOM
}

model SavingsGoal {
  id             String          @id @default(cuid())
  name           String
  type           GoalType
  targetAmount   Decimal         @db.Decimal(12, 2)
  currentAmount  Decimal         @default(0) @db.Decimal(12, 2)
  deadline       DateTime?
  priority       Int             @default(1)  // 1 = highest priority
  icon           String?
  color          String?
  metadata       Json?           // Flexible storage for type-specific data
  isCompleted    Boolean         @default(false)
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions  Contribution[]
  babyMilestones BabyMilestone[]
  houseGoal      HouseGoal?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("savings_goals")
}

model Contribution {
  id            String       @id @default(cuid())
  amount        Decimal      @db.Decimal(10, 2)
  note          String?
  goalId        String
  goal          SavingsGoal  @relation(fields: [goalId], references: [id], onDelete: Cascade)
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  createdAt     DateTime     @default(now())

  @@map("contributions")
}

// Baby Savings Milestones
enum MilestoneCategory {
  PRE_BIRTH
  NURSERY
  GEAR
  FIRST_YEAR
  CHILDCARE
  HEALTHCARE
  EDUCATION
}

model BabyMilestone {
  id            String            @id @default(cuid())
  goalId        String
  goal          SavingsGoal       @relation(fields: [goalId], references: [id], onDelete: Cascade)
  name          String
  category      MilestoneCategory
  targetAmount  Decimal           @db.Decimal(10, 2)
  currentAmount Decimal           @default(0) @db.Decimal(10, 2)
  isCompleted   Boolean           @default(false)
  dueMonth      Int?              // Months from birth when expense occurs (0 = pre-birth, negative = before birth)
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@map("baby_milestones")
}

// House Savings System
model HouseGoal {
  id                String             @id @default(cuid())
  goalId            String             @unique
  goal              SavingsGoal        @relation(fields: [goalId], references: [id], onDelete: Cascade)
  targetPrice       Decimal            @db.Decimal(12, 2)
  targetLocation    String?            // City, State or ZIP
  targetBedrooms    Int?
  targetBathrooms   Float?
  downPaymentPct    Float              @default(20)
  propertyType      String?            // single_family, condo, townhouse, etc.
  savedSearches     Json?              // Array of saved search criteria
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  savedProperties   PropertySnapshot[]

  @@map("house_goals")
}

model PropertySnapshot {
  id            String    @id @default(cuid())
  houseGoalId   String
  houseGoal     HouseGoal @relation(fields: [houseGoalId], references: [id], onDelete: Cascade)
  zpid          String?   // Zillow property ID (or other provider ID)
  address       String
  city          String
  state         String
  zipCode       String
  price         Decimal   @db.Decimal(12, 2)
  bedrooms      Int?
  bathrooms     Float?
  sqft          Int?
  yearBuilt     Int?
  propertyType  String?
  zestimate     Decimal?  @db.Decimal(12, 2)
  imageUrl      String?
  listingUrl    String?
  isFavorite    Boolean   @default(false)
  notes         String?
  capturedAt    DateTime  @default(now())

  @@map("property_snapshots")
}

// ==========================================
// Bank Statement Import System
// ==========================================

enum AccountType {
  CREDIT_CARD
  CHECKING
  SAVINGS
  INVESTMENT
}

enum DocumentStatus {
  PENDING      // Just uploaded
  PROCESSING   // Being processed by AI
  EXTRACTED    // Transactions extracted, awaiting review
  REVIEWED     // User has reviewed
  IMPORTED     // Transactions imported
  FAILED       // Processing failed
}

enum PendingTransactionStatus {
  PENDING      // Awaiting review
  APPROVED     // User approved
  REJECTED     // User rejected
  IMPORTED     // Moved to Transaction table
  DUPLICATE    // Detected as duplicate
}

// Track bank accounts and credit cards
model BankAccount {
  id           String       @id @default(cuid())
  name         String       // "Chase Freedom", "Amex Gold", "BofA Checking"
  bankName     String       // "Chase", "American Express", "Bank of America"
  accountType  AccountType
  lastFour     String?      // Last 4 digits for identification
  isActive     Boolean      @default(true)
  userId       String
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents    BankDocument[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@map("bank_accounts")
}

// Track uploaded bank statement documents
model BankDocument {
  id                  String               @id @default(cuid())
  filename            String               // Stored filename (UUID)
  originalName        String               // User's original filename
  fileSize            Int                  // Size in bytes
  mimeType            String               // application/pdf
  filePath            String               // Path to stored file
  status              DocumentStatus       @default(PENDING)
  bankAccountId       String?
  bankAccount         BankAccount?         @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  statementStartDate  DateTime?            // Statement period start
  statementEndDate    DateTime?            // Statement period end
  extractedData       Json?                // Raw LLM extraction output
  processingError     String?              // Error message if failed
  transactionCount    Int?                 // Number of transactions found
  llmProvider         String?              // Which LLM was used (ollama, openai)
  llmModel            String?              // Which model (llama3.2, gpt-4o-mini)
  processingTimeMs    Int?                 // How long processing took
  userId              String
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  pendingTransactions PendingTransaction[]
  uploadedAt          DateTime             @default(now())
  processedAt         DateTime?
  updatedAt           DateTime             @updatedAt

  @@map("bank_documents")
}

// Staging table for extracted transactions awaiting review
model PendingTransaction {
  id            String                   @id @default(cuid())
  documentId    String
  document      BankDocument             @relation(fields: [documentId], references: [id], onDelete: Cascade)
  date          DateTime
  description   String
  originalDescription String?            // Raw description from PDF
  amount        Decimal                  @db.Decimal(10, 2)
  type          String                   // INCOME or EXPENSE
  category      String?                  // LLM-suggested category
  suggestedCategories Json?              // Array of {category, confidence}
  confidence    Float?                   // Overall confidence score 0-1
  rawText       String?                  // Original line from PDF
  lineNumber    Int?                     // Position in document
  status        PendingTransactionStatus @default(PENDING)
  userCategory  String?                  // User's override category
  userNotes     String?                  // User's notes
  importedTransactionId String?          // Link to Transaction after import
  duplicateOfId String?                  // If duplicate, link to existing Transaction
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt

  @@map("pending_transactions")
}

// ==========================================
// Health Module - Fitness, Nutrition, Wellness
// ==========================================

enum WorkoutType {
  CARDIO
  STRENGTH
  FLEXIBILITY
  SPORTS
  OTHER
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

/// Workout/exercise session tracking
model Workout {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String      // "Morning Run", "Leg Day", etc.
  type        WorkoutType
  duration    Int         // Duration in minutes
  calories    Int?        // Estimated calories burned
  notes       String?
  exercises   Json?       // Array of exercises with sets/reps/weight
  date        DateTime    @default(now())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("workouts")
}

/// Weight tracking over time
model WeightLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weight    Decimal  @db.Decimal(5, 2) // Weight in user's preferred unit
  unit      String   @default("kg")    // "kg" or "lbs"
  bodyFat   Decimal? @db.Decimal(4, 1) // Body fat percentage
  notes     String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@map("weight_logs")
}

/// Meal/nutrition tracking
model Meal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String   // "Chicken Salad", "Protein Shake"
  type        MealType
  calories    Int?
  protein     Decimal? @db.Decimal(6, 1) // grams
  carbs       Decimal? @db.Decimal(6, 1) // grams
  fat         Decimal? @db.Decimal(6, 1) // grams
  fiber       Decimal? @db.Decimal(6, 1) // grams
  notes       String?
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("meals")
}

/// Sleep tracking
model SleepLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bedTime   DateTime // When user went to bed
  wakeTime  DateTime // When user woke up
  duration  Int      // Duration in minutes (calculated)
  quality   Int?     // 1-5 rating
  notes     String?
  date      DateTime @default(now()) // The date this sleep is logged for
  createdAt DateTime @default(now())

  @@map("sleep_logs")
}

/// Water intake tracking (daily)
model WaterLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Int      // Amount in ml
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@map("water_logs")
}

/// Health goals (weight goal, fitness goals, etc.)
model HealthGoal {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         String    // "weight", "steps", "workout_frequency", etc.
  targetValue  Decimal   @db.Decimal(10, 2)
  currentValue Decimal   @default(0) @db.Decimal(10, 2)
  unit         String    // "kg", "lbs", "steps", "days/week"
  deadline     DateTime?
  isCompleted  Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("health_goals")
}
