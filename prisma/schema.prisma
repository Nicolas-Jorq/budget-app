generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String
  password     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  budgets      Budget[]
  transactions Transaction[]
  savingsGoals SavingsGoal[]

  @@map("users")
}

model Budget {
  id           String        @id @default(cuid())
  name         String
  amount       Decimal       @db.Decimal(10, 2)
  spent        Decimal       @default(0) @db.Decimal(10, 2)
  category     String
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("budgets")
}

model Transaction {
  id             String        @id @default(cuid())
  description    String
  amount         Decimal       @db.Decimal(10, 2)
  type           String        // 'income' or 'expense'
  category       String
  date           DateTime
  budgetId       String?
  budget         Budget?       @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions  Contribution[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("transactions")
}

// Savings Goals System
enum GoalType {
  EMERGENCY_FUND
  BABY
  HOUSE
  VEHICLE
  VACATION
  EDUCATION
  RETIREMENT
  CUSTOM
}

model SavingsGoal {
  id             String          @id @default(cuid())
  name           String
  type           GoalType
  targetAmount   Decimal         @db.Decimal(12, 2)
  currentAmount  Decimal         @default(0) @db.Decimal(12, 2)
  deadline       DateTime?
  priority       Int             @default(1)  // 1 = highest priority
  icon           String?
  color          String?
  metadata       Json?           // Flexible storage for type-specific data
  isCompleted    Boolean         @default(false)
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions  Contribution[]
  babyMilestones BabyMilestone[]
  houseGoal      HouseGoal?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("savings_goals")
}

model Contribution {
  id            String       @id @default(cuid())
  amount        Decimal      @db.Decimal(10, 2)
  note          String?
  goalId        String
  goal          SavingsGoal  @relation(fields: [goalId], references: [id], onDelete: Cascade)
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  createdAt     DateTime     @default(now())

  @@map("contributions")
}

// Baby Savings Milestones
enum MilestoneCategory {
  PRE_BIRTH
  NURSERY
  GEAR
  FIRST_YEAR
  CHILDCARE
  HEALTHCARE
  EDUCATION
}

model BabyMilestone {
  id            String            @id @default(cuid())
  goalId        String
  goal          SavingsGoal       @relation(fields: [goalId], references: [id], onDelete: Cascade)
  name          String
  category      MilestoneCategory
  targetAmount  Decimal           @db.Decimal(10, 2)
  currentAmount Decimal           @default(0) @db.Decimal(10, 2)
  isCompleted   Boolean           @default(false)
  dueMonth      Int?              // Months from birth when expense occurs (0 = pre-birth, negative = before birth)
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@map("baby_milestones")
}

// House Savings System
model HouseGoal {
  id                String             @id @default(cuid())
  goalId            String             @unique
  goal              SavingsGoal        @relation(fields: [goalId], references: [id], onDelete: Cascade)
  targetPrice       Decimal            @db.Decimal(12, 2)
  targetLocation    String?            // City, State or ZIP
  targetBedrooms    Int?
  targetBathrooms   Float?
  downPaymentPct    Float              @default(20)
  propertyType      String?            // single_family, condo, townhouse, etc.
  savedSearches     Json?              // Array of saved search criteria
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  savedProperties   PropertySnapshot[]

  @@map("house_goals")
}

model PropertySnapshot {
  id            String    @id @default(cuid())
  houseGoalId   String
  houseGoal     HouseGoal @relation(fields: [houseGoalId], references: [id], onDelete: Cascade)
  zpid          String?   // Zillow property ID (or other provider ID)
  address       String
  city          String
  state         String
  zipCode       String
  price         Decimal   @db.Decimal(12, 2)
  bedrooms      Int?
  bathrooms     Float?
  sqft          Int?
  yearBuilt     Int?
  propertyType  String?
  zestimate     Decimal?  @db.Decimal(12, 2)
  imageUrl      String?
  listingUrl    String?
  isFavorite    Boolean   @default(false)
  notes         String?
  capturedAt    DateTime  @default(now())

  @@map("property_snapshots")
}
